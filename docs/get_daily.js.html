<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: get_daily.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: get_daily.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @author IITII
 * @date 2020/9/19 12:34
 */
'use strict';
const config = require('../config'),
  fetch = require('node-fetch'),
  cheerio = require('cheerio'),
  _ = require('lodash'),
  fs = require('fs'),
  path = require('path'),
  {logger} = require("./logger"),
  webdriver = require('selenium-webdriver'),
  By = webdriver.By,
  BROWSER = 'chrome',
  chrome = require(`selenium-webdriver/${BROWSER}`),
  until = webdriver.until,
  utils = require('./utils'),
  HttpsProxyAgent = require('https-proxy-agent'),
  PIXIV_USERNAME = config.pixiv.username,
  PIXIV_PASSWORD = config.pixiv.password;

let User_Agent = config.user_agent;

/**
 * return dom base on url
 * @param url Telegraph URL
 * @param proxy http proxy
 * @return {Promise&lt;*>} cheerio
 */
async function getDom(url, proxy) {
  let data = await (utils.isNil(proxy)
    ? fetch(url)
    : fetch(url, {
      agent: new HttpsProxyAgent(proxy)
    }));
  let text = await data.text();
  return await cheerio.load(text);
}

/**
 * Login to pixiv
 * @param driver selenium driver
 * @param username pixiv username
 * @param password pixiv password
 */
async function login(driver, username, password) {
  await driver.get('https://accounts.pixiv.net/login');
  await driver.wait(until.elementsLocated(By.id('LoginComponent')), 60000);
  let js = await fs.readFileSync(path.resolve(__dirname, '../dom/login.js'), {
    encoding: 'utf-8'
  });
  js = js.replace('username', username)
    .replace('password', password);
  await driver.executeScript(`${js}`);
  await utils.sleep(2000);
}

/**
 * Get Daily Rank Url
 * @param limit limit array size max: 50, default: 50
 * @return Array A array for Daily Rank Url with limit
 */
async function getDailyRankUrl(limit = 50) {
  return await new Promise(async (resolve, reject) => {
      try {
        if (limit &lt;= 0 || limit > 50) {
          return reject('Limit should greater than 0 and less than 50');
        }
        const DAILY_RANKING_URL = 'https://www.pixiv.net/ranking.php?mode=daily&amp;content=illust';
        let illustrationArray = [];
        let $ = await getDom(DAILY_RANKING_URL, config.pixiv.proxy || config.proxy || process.env.HTTP_PROXY || null);
        await $('.work').each((index, item) => {
          // MAX ARRAY SIZE: 50
          if (index &lt; limit) {
            illustrationArray.push(new URL(DAILY_RANKING_URL).origin + item.attribs.href);
          }
        })
        return resolve(illustrationArray);
      } catch (e) {
        return reject(e);
      }
    }
  )
}

/**
 * Get img origin url
 * @param driver selenium driver
 * @param imgUrl {URL}
 * @param js {String}
 * @return Array {Array} array length maybe greater than 1
 */
async function getRealImgUrl(driver, imgUrl, js) {
  return await new Promise(async resolve => {
    await driver.get(imgUrl);
    await driver.wait(until.elementLocated(By.css('div[role="presentation"] > a')), 600000)
    await driver.findElement(By.css('div[role="presentation"] > a')).click();
    await utils.sleep(1000);
    let array = await driver.executeScript(`return ${js}`);
    return resolve(array);
  });
}

async function getDaily() {
  return await new Promise(async (resolve, reject) => {
    if (utils.isNil(PIXIV_USERNAME) || utils.isNil(PIXIV_PASSWORD)) {
      return reject('Empty PIXIV_USERNAME or PIXIV_PASSWORD!!!');
    }
    try {
      const driver = new webdriver.Builder()
        .forBrowser(BROWSER)
        .setChromeOptions(new chrome.Options().addArguments(config.webdriver.args))
        .build();
      let rankUrls = await getDailyRankUrl();
      // Remove duplicate
      rankUrls = _.uniq(rankUrls);
      await login(driver, PIXIV_USERNAME, PIXIV_PASSWORD);
      // Update user_agent with live chrome user_agent
      User_Agent = await driver.executeScript(`return navigator.userAgent`)
        || User_Agent;
      let js = await fs.readFileSync(path.resolve(__dirname, '../dom/img.js'), {
        encoding: 'utf-8'
      });
      let data = [];
      for (const rankUrl of rankUrls) {
        let tmp = await getRealImgUrl(driver, rankUrl, js);
        tmp.forEach(e => {
          logger.info(`Got ${e} from ${rankUrl}`);
          data.push({
            url: e,
            origin: rankUrl,
            // Duplicate with a very low probability
            savePath: config.save.currentImgSaveDir + path.sep + path.basename(new URL(e).pathname)
          });
        });
      }
      // async quit, just for reduce time
      driver.quit().then(() => {
        logger.info(`driver quit successfully!!!`);
      })
        .catch(e => {
          logger.error(`driver quit failed!!!`);
          logger.error(e);
        });
      return resolve(_.uniqBy(data, 'url'));
    } catch (e) {
      return reject(e);
    }
  });
}

module.exports = {
  getDaily
};</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#cdn_preheating">cdn_preheating</a></li><li><a href="global.html#cdn_preheatingtasks">cdn_preheatingtasks</a></li><li><a href="global.html#cdn_refreshtasks">cdn_refreshtasks</a></li><li><a href="global.html#checkUrl">checkUrl</a></li><li><a href="global.html#get_bytes">get_bytes</a></li><li><a href="global.html#getDailyRankUrl">getDailyRankUrl</a></li><li><a href="global.html#getDom">getDom</a></li><li><a href="global.html#getRealImgUrl">getRealImgUrl</a></li><li><a href="global.html#getToken">getToken</a></li><li><a href="global.html#got">got</a></li><li><a href="global.html#got_instance">got_instance</a></li><li><a href="global.html#human_net_speed">human_net_speed</a></li><li><a href="global.html#hwc_common">hwc_common</a></li><li><a href="global.html#isNil">isNil</a></li><li><a href="global.html#live_net_speed">live_net_speed</a></li><li><a href="global.html#logger">logger</a></li><li><a href="global.html#login">login</a></li><li><a href="global.html#mkdir">mkdir</a></li><li><a href="global.html#showHistoryTaskDetails">showHistoryTaskDetails</a></li><li><a href="global.html#sleep">sleep</a></li><li><a href="global.html#spendTime">spendTime</a></li><li><a href="global.html#wait_for_low_traffic_usage">wait_for_low_traffic_usage</a></li><li><a href="global.html#waitForRefreshTaskDone">waitForRefreshTaskDone</a></li><li><a href="global.html#zipDir">zipDir</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.5</a> on Mon Sep 21 2020 17:14:44 GMT+0800 (GMT+08:00)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
